# Spring에서 동시성 제어 방법 비교

Spring에서는 다양한 동시성 제어 방법이 존재합니다. 이번 예제에서는 이전에 학습해봤던 [[인프런] 재고시스템으로 알아보는 동시성이슈 해결방법 강의 학습 코드](https://github.com/kgh2120/concurrent-issue-study)를 기반으로 조금 더 다양한 방법과 특징에 대해서 정리해보았습니다.

그리고 성능 테스트를 통해서 각각의 방법이 어느정도 수준의 퍼포먼스를 보여주는지에 대해 알아보았습니다.

간단한 특징 정리입니다.

| 이름 | 특징 |
|------|-------|
| synchronized | java에서 활용 가능한 Mutex 기반의 방법. 내부적으로 존재하는 Monitor라는 Lock을 획득해 공유 자원에 대한 접근을 진행한다. 메서드의 시그니처 혹은 블럭 형태로 사용할 수 있다. Spring AOP로 인해 프록시로 접근하는 것을 유의해서 Facade 클래스를 만들어서 사용해야 한다. 단일 인스턴스에서만 적용 가능하다는 특징이 있다. |
| ReentrantLock | java에서 활용 가능한 Lock 구현체. synchronized와 마찬가지로 mutex 기반으로 동작한다. Lock에 대한 상태 정보나 공정성 등을 설정할 수 있는 synchronized보다는 조금 더 확장된 형태를 띈다. 그 외에는 동일한 특징을 가진다. |
| Exclusive Lock | 데이터베이스의 Row 혹은 테이블에 대한 Lock을 획득해 다른 트랜잭션의 접근을 제한하는 방법. 복수의 서버 인스턴스 환경에서도 동시성 제어가 가능하다. 하지만 Lock으로 인해 성능 저하가 발생할 수 있다. |
| Optimistic Lock | 충돌이 발생하지 않은 것을 전제로 제작된 동시성 제어 방법. 별도의 lock을 사용하지 않고 데이터베이스의 속성 값을 커밋 시점에서 비교하는 것으로 충돌을 감지한다. 충돌이 발생하면 트랜잭션을 재시도하는 방법으로 동작한다. 재시도 로직을 위해 별도의 Facade 클래스를 생성해줘야 하고, 충돌이 발생하면 성능이 좋지 못한 편에 속한다. |
| Redis Lettuce Lock | Spring Data Redis에서 기본으로 활용하는 Lettuce 라이브러리를 활용한 Lock기법. SetNX 연산을 기반으로 락을 획득하는 형태로 동작한다. Redis를 활용해 분산 데이터베이스 시스템 상에서도 동시성 제어가 가능해 분산 락이라고도 불린다. |
| Redis Redisson Lock | Redisson 라이브러리를 활용한 Lock 기법. Redis의 Pub-Sub 기반으로 Lock을 획득하고, Lock 제어 기능이 구현되어 있어 충돌 상황에서도 높은 퍼포먼스를 보이는 것이 특징이다. |

다음은 충돌 상황 100명이 5분동안 동일한 자원에 접근하는 시나리오에 대한 성능 테스트 결과입니다.

![성능 테스트 결과](https://velog.velcdn.com/images/kgh2120/post/b05d0da6-6f26-47e9-adbf-bbb5cbf5d7c6/image.png)

지속적 충돌 상황에서는 충돌을 가정하고 동작하는 비관락(Exclusive Lock)의 성능이 가장 좋았고, Redisson Lock이 그 뒤를 따라갑니다. 하지만 Exclusive Lock의 경우 다른 API와도 충돌할 수 있고 이로 인한 성능 저하가 발생할 수 있기 때문에, 가장 무난한 방법은 Redisson Lock이라고 생각됩니다. Redis를 활용하기 곤란한 경우에는 독립적인 기법인 Optimistic Lock을 사용하는 것도 좋은 선택이 될 수 있습니다. 실제로 많은 기업들에서 잦은 충돌(1초에 여러번)이 발생하지는 않기 때문에 Optimistic Lock을 기본으로 사용하고 있으며, 충돌이 잦은 상황에서는 별도의 제어 방법을 이용한다고 합니다.